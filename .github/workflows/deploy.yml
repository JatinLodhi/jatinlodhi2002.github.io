name: Deploy DevOps Portfolio to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Validation and Linting Job
  validate:
    name: Validate HTML/CSS/JS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: ./
          css: true
          format: text
        continue-on-error: true

      - name: Install Linters
        run: |
          npm install -g stylelint stylelint-config-standard
          npm install -g eslint

      - name: Lint CSS
        run: |
          echo "Running CSS linter..."
          stylelint "*.css" --config-basedir $(npm root -g) || echo "CSS linting completed with warnings"
        continue-on-error: true

      - name: Lint JavaScript
        run: |
          echo "Running JavaScript linter..."
          eslint *.js --no-eslintrc --env browser,es6 || echo "JS linting completed with warnings"
        continue-on-error: true

      - name: Check File Sizes
        run: |
          echo "Checking asset sizes..."
          find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -exec ls -lh {} \;

  # Build and Optimize Job
  build:
    name: Build and Optimize
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Create Optimized Build
        run: |
          echo "Creating optimized build..."
          mkdir -p _site
          
          # Copy all necessary files
          cp index.html _site/
          cp style.css _site/
          cp script.js _site/
          
          # Copy assets if they exist
          if [ -d "assets" ]; then
            cp -r assets _site/
          fi
          
          # Create robots.txt
          cat > _site/robots.txt << 'EOF'
          User-agent: *
          Allow: /
          Sitemap: https://jatinlodhi2002.github.io/sitemap.xml
          EOF
          
          # Create sitemap.xml
          cat > _site/sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://jatinlodhi2002.github.io/</loc>
              <lastmod>$(date +%Y-%m-%d)</lastmod>
              <changefreq>weekly</changefreq>
              <priority>1.0</priority>
            </url>
          </urlset>
          EOF
          
          # Create .nojekyll to prevent Jekyll processing
          touch _site/.nojekyll
          
          echo "Build completed successfully!"

      - name: Display Build Info
        run: |
          echo "ğŸ“¦ Build Artifacts:"
          ls -la _site/
          echo ""
          echo "ğŸ“Š File Sizes:"
          du -sh _site/*

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  # Deploy to GitHub Pages Job
  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Success Summary
        if: success()
        run: |
          echo "ğŸ‰ Deployment Successful!"
          echo "=================================="
          echo "âœ… Site Status: Live"
          echo "ğŸŒ URL: https://jatinlodhi2002.github.io"
          echo "ğŸ“… Deployed: $(date)"
          echo "ğŸ”§ Deployment ID: ${{ steps.deployment.outputs.page_url }}"
          echo "=================================="

      - name: Create Deployment Badge
        if: success()
        run: |
          echo "Creating deployment status badge..."
          echo "Badge: [![Deployment](https://img.shields.io/badge/deployment-active-success)](https://jatinlodhi2002.github.io)"

  # Performance Testing Job (Optional)
  performance-test:
    name: Performance Audit
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for Deployment
        run: |
          echo "Waiting 30 seconds for deployment to propagate..."
          sleep 30

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://jatinlodhi2002.github.io
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

      - name: Performance Summary
        run: |
          echo "ğŸš€ Performance audit completed!"
          echo "Check Lighthouse report in artifacts"
